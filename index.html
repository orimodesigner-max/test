<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Location-based AR Final Fix</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        #debug {
            position: fixed;
            z-index: 10000;
            background-color: rgba(0, 0, 0, 0.8);
            color: yellow;
            font-size: 20px;
            padding: 15px;
            top: 10px;
            left: 10px;
            width: 90%;
            border: 2px solid white;
            font-family: monospace;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="debug">
        システム起動中...<br>
        (赤い箱を探してください)
    </div>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;" 
    >
        <a-box
            id="target-box"
            material="color: red"
            gps-entity-place="latitude: 35.701820413676195; longitude: 139.8251889595972;"
            scale="30 30 30"
            look-at="[gps-camera]"
        ></a-box>

        <a-camera gps-camera="minDistance: 0; maxDistance: 2000;" rotation-reader></a-camera>
    </a-scene>

    <script>
        window.addEventListener('load', () => {
            const debugDiv = document.getElementById('debug');
            const target = document.getElementById('target-box');

            // 1. GPSが動いているか（スマホ側）
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((pos) => {
                    // ここが動けば「GPS許可」はOK
                    // debugDiv.innerHTML = `GPS信号受信中...<br>精度: ${Math.round(pos.coords.accuracy)}m`;
                }, (err) => {
                    debugDiv.innerHTML = `<span style="color:red">GPSエラー: ${err.message}</span>`;
                });
            }

            // 2. ARエンジンが距離を計算できたか
            target.addEventListener('gps-entity-place-update-positon', (event) => {
                // 注: 最新版AR.jsでもイベント名のスペルミス(positon)が残っている場合があるため両方対応
                updateDistance(event.detail.distance);
            });
            // 正しいスペルの方も念のため記述
            target.addEventListener('gps-entity-place-update-position', (event) => {
                updateDistance(event.detail.distance);
            });

            function updateDistance(distance) {
                const distInt = Math.round(distance);
                debugDiv.innerHTML = `
                    <span style="color:cyan">★ARエンジン接続成功★</span><br>
                    ターゲットまでの距離: <span style="font-size:30px">${distInt}m</span><br>
                    (30mの巨大な赤い箱があります)
                `;
                
                // 距離に応じて色を変える（50m以内なら青）
                if(distInt < 50) {
                    target.setAttribute('material', 'color: blue');
                    debugDiv.innerHTML += "<br><span style='color:lime'>近いです！見回してください！</span>";
                }
            }
        });
    </script>
</body>
</html>