<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Debug Final</title>

    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        #console-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
            z-index: 9999;
            overflow-y: scroll;
            pointer-events: none;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="console-ui">
        === 診断ログ Ver 3.0 ===<br>
        初期化を開始します...<br>
    </div>

    <script>
        // 画面上のログ機能（console.logなどを乗っ取る）
        const ui = document.getElementById('console-ui');
        function logToScreen(msg, color = '#0f0') {
            ui.innerHTML += `<span style="color:${color}">> ${msg}</span><br>`;
            ui.scrollTop = ui.scrollHeight;
        }

        // 内部エラーを画面に出す
        window.onerror = function(message, source, lineno, colno, error) {
            logToScreen(`[ERROR] ${message}`, 'red');
        };
        console.log = function(msg) { logToScreen(msg); };
        console.error = function(msg) { logToScreen(msg, 'red'); };
    </script>

    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
    >
        <a-box
            id="target-box"
            material="color: yellow"
            gps-entity-place="latitude: 35.701820413676195; longitude: 139.8251889595972;"
            scale="30 30 30"
        ></a-box>

        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
        window.onload = function() {
            logToScreen("Window Loaded. A-Frame準備中...");

            const scene = document.querySelector('a-scene');
            const box = document.getElementById('target-box');

            if (scene.hasLoaded) {
                logToScreen("A-Scene ロード完了");
            } else {
                scene.addEventListener('loaded', () => {
                    logToScreen("A-Scene ロード完了(遅延)");
                });
            }

            // GPS位置更新イベントの監視
            box.addEventListener('gps-entity-place-update-position', (event) => {
                const dist = Math.round(event.detail.distance);
                logToScreen(`距離計算成功: 残り${dist}m`, 'cyan');
                box.setAttribute('material', 'color: red'); // 成功したら赤になる
            });

            // GPSカメラの初期化監視
            window.addEventListener('gps-camera-origin-coord-set', () => {
                logToScreen("★GPS基準点の設定完了★", 'yellow');
            });
            
            // カメラのエラー監視
            window.addEventListener('gps-camera-update-position', (e) => {
                // 頻繁に出るのでコメントアウトしてもいいが、最初は確認のため出す
                // logToScreen(`GPS更新: ${e.detail.position.longitude}`);
            });
        };
    </script>
</body>
</html>